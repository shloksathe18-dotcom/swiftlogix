{% extends 'base.html' %}
{% block content %}
<script>
  // Set dashboard title for driver
  document.addEventListener('DOMContentLoaded', function() {
    const dashboardTitle = document.getElementById('dashboardTitle');
    if (dashboardTitle) {
      dashboardTitle.textContent = ' | Driver Dashboard';
    }
  });
</script>

<div class="dashboard-header mb-4 animate-fadeIn">
  <h2>Driver Dashboard</h2>
</div>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Your Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="profileContent">
        <div class="text-center mb-4">
          <div class="profile-icon bg-primary text-white rounded-circle mx-auto mb-3" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
            ðŸšš
          </div>
          <h5 id="profileName"></h5>
          <p class="text-muted mb-1" id="profileEmail"></p>
          <p class="text-muted small" id="profileDriverId"></p>
        </div>
        <div id="profileDetails">
          <!-- Profile details will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editProfileForm">
          <div class="mb-3">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-control" id="editName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="editEmail" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Phone Number</label>
            <input type="tel" class="form-control" id="editPhone">
          </div>
          <div class="mb-3">
            <label class="form-label">License Number</label>
            <input type="text" class="form-control" id="editLicenseNumber">
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Vehicle Type</label>
              <select class="form-select" id="editVehicleType">
                <option value="">Select Vehicle Type</option>
                <option value="bike">Bike</option>
                <option value="scooter">Scooter</option>
                <option value="car">Car</option>
                <option value="van">Van</option>
                <option value="truck">Truck</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Vehicle Number</label>
              <input type="text" class="form-control" id="editVehicleNumber">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="updateProfile()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Location Access Modal -->
<div class="modal fade" id="locationAccessModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Location Access Required</h5>
      </div>
      <div class="modal-body">
        <p class="text-center mb-4">To provide you with the best service, we need access to your location.</p>
        <div class="mb-3">
          <button class="btn btn-primary w-100 mb-3" id="grantLocationBtn">
            <i class="fas fa-location-arrow"></i> Grant Location Access
          </button>
          <p class="text-center text-muted">OR</p>
          <button class="btn btn-outline-primary w-100" id="selectLocationOnMapBtn">
            <i class="fas fa-map-marker-alt"></i> Select on Map
          </button>
        </div>
        <div id="mapSelector" style="display: none;">
          <div id="locationMap" style="height: 300px; border-radius: 10px; border: 1px solid #ddd;"></div>
          <div class="mt-2">
            <small class="text-muted">Click on the map to select your location</small>
            <div id="selectedLocation" class="mt-1 fw-bold"></div>
          </div>
          <div class="mt-3">
            <button class="btn btn-success w-100" id="confirmLocationBtn" disabled>
              Confirm Location
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dashboard Stats -->
<div class="row mb-4">
  <div class="col-md-6 col-lg-3 mb-4">
    <div class="card stat-card h-100">
      <div class="card-body text-center">
        <div class="stat-icon bg-primary text-white rounded-circle mb-3 mx-auto">
          <i class="fas fa-box"></i>
        </div>
        <h3 id="totalOrders" class="mb-1">0</h3>
        <p class="text-muted mb-0">Total Orders</p>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-lg-3 mb-4">
    <div class="card stat-card h-100">
      <div class="card-body text-center">
        <div class="stat-icon bg-success text-white rounded-circle mb-3 mx-auto">
          <i class="fas fa-rupee-sign"></i>
        </div>
        <h3 id="totalEarnings" class="mb-1">â‚¹0</h3>
        <p class="text-muted mb-0">Total Earnings</p>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-lg-3 mb-4">
    <div class="card stat-card h-100">
      <div class="card-body text-center">
        <div class="stat-icon bg-info text-white rounded-circle mb-3 mx-auto">
          <i class="fas fa-list"></i>
        </div>
        <h3 id="availableOrdersCount" class="mb-1">0</h3>
        <p class="text-muted mb-0">Available Orders</p>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-lg-3 mb-4">
    <div class="card stat-card h-100">
      <div class="card-body text-center">
        <div class="stat-icon bg-warning text-white rounded-circle mb-3 mx-auto">
          <i class="fas fa-tasks"></i>
        </div>
        <h3 id="assignedOrdersCount" class="mb-1">0</h3>
        <p class="text-muted mb-0">Assigned Orders</p>
      </div>
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="d-flex flex-wrap gap-3">
      <button class="btn btn-primary btn-lg flex-fill" onclick="refreshDashboard()" style="cursor: pointer;">
        <i class="fas fa-sync-alt me-2"></i>Refresh Dashboard
      </button>
      <button class="btn btn-success btn-lg flex-fill" onclick="loadAvailableOrdersModal()" style="cursor: pointer;">
        <i class="fas fa-list-alt me-2"></i>View Available Orders
      </button>
      <button class="btn btn-info btn-lg flex-fill" onclick="loadAssignedOrdersModal()" style="cursor: pointer;">
        <i class="fas fa-tasks me-2"></i>View Assigned Orders
      </button>
    </div>
  </div>
</div>

<!-- Available Orders Modal -->
<div class="modal fade" id="availableOrdersModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Available Orders</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="availableOrdersLoading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
        </div>
        <div id="availableOrdersContent" style="display: none;">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Pickup Location</th>
                  <th>Delivery Location</th>
                  <th>Fare</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="availableOrdersList"></tbody>
            </table>
          </div>
        </div>
        <div id="noAvailableOrders" style="display: none;" class="text-center py-4">
          <p class="text-muted">No available orders at the moment.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Assigned Orders Modal -->
<div class="modal fade" id="assignedOrdersModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assigned Orders</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="assignedOrdersLoading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
        </div>
        <div id="assignedOrdersContent" style="display: none;">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Pickup</th>
                  <th>Delivery</th>
                  <th>Status</th>
                  <th>Earnings</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="assignedOrdersList"></tbody>
            </table>
          </div>
        </div>
        <div id="noAssignedOrders" style="display: none;" class="text-center py-4">
          <p class="text-muted">You have no assigned orders.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Vehicle Information Card -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="fas fa-car me-2"></i>Vehicle Information
    </h5>
  </div>
  <div class="card-body">
    <div id="vehicleLoading" class="text-center py-4">
      <div class="spinner-border text-primary" role="status"></div>
    </div>
    <div id="vehicleData" style="display: none;">
      <div class="row">
        <div class="col-md-6">
          <p><strong>Vehicle Type:</strong> <span id="vehicleType">-</span></p>
          <p><strong>Vehicle Number:</strong> <span id="vehicleNumber">-</span></p>
        </div>
        <div class="col-md-6">
          <p><strong>License Number:</strong> <span id="licenseNumber">-</span></p>
          <p><strong>Status:</strong> <span id="driverStatus" class="badge bg-success">Available</span></p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Script moved to the end of the file to ensure proper loading order -->

  // Prevent duplicate execution in Quder AI
  if (window.__driverLoaded__) {
    console.warn("driver.js already loaded â€” skipping duplicate execution");
    throw new Error("Duplicate driver.js execution prevented by guard");
  }
  window.__driverLoaded__ = true;

  // Namespace for all global map variables
  window.SwiftLogixGlobals = window.SwiftLogixGlobals || {};

  // Initialize globals safely
  window.SwiftLogixGlobals.locationMap    = window.SwiftLogixGlobals.locationMap    || null;
  window.SwiftLogixGlobals.locationMarker = window.SwiftLogixGlobals.locationMarker || null;
  window.SwiftLogixGlobals.selectedLat    = window.SwiftLogixGlobals.selectedLat    || null;
  window.SwiftLogixGlobals.selectedLng    = window.SwiftLogixGlobals.selectedLng    || null;

  // Show location access modal with retry mechanism
  function showLocationAccessModal() {
    if (typeof bootstrap !== 'undefined') {
      const modal = new bootstrap.Modal(document.getElementById('locationAccessModal'), {
        backdrop: 'static',
        keyboard: false
      });
      modal.show();
    } else {
      // Retry after a short delay
      setTimeout(showLocationAccessModal, 100);
    }
  }

  // Grant location access
  document.getElementById('grantLocationBtn').addEventListener('click', function() {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser');
      return;
    }
    
    navigator.geolocation.getCurrentPosition(
      async (position) => {
        try {
          await updateLocationOnServer(position.coords.latitude, position.coords.longitude);
          
          // Close modal
          if (typeof bootstrap !== 'undefined') {
            const modal = bootstrap.Modal.getInstance(document.getElementById('locationAccessModal'));
            if (modal) {
              modal.hide();
            }
          }
          
          // Show success message
          showToast('Location updated successfully!', 'success');
        } catch (error) {
          console.error('Failed to update location:', error);
          alert('Failed to update location. Please try again.');
        }
      },
      (error) => {
        console.error('Error getting location:', error);
        alert('Unable to retrieve your location. Please try selecting on the map.');
      }
    );
  });

  // Select location on map
  document.getElementById('selectLocationOnMapBtn').addEventListener('click', function() {
    document.getElementById('mapSelector').style.display = 'block';
    
    // Initialize map if not already done
    if (!window.SwiftLogixGlobals.locationMap) {
      window.SwiftLogixGlobals.locationMap = SwiftLogix.initMap('locationMap', 28.6139, 77.2090, 12);
      
      // Add click event to map
      window.SwiftLogixGlobals.locationMap.on('click', function(e) {
        // Remove existing marker if any
        if (window.SwiftLogixGlobals.locationMarker) {
          window.SwiftLogixGlobals.locationMap.removeLayer(window.SwiftLogixGlobals.locationMarker);
        }
        
        // Add new marker
        window.SwiftLogixGlobals.locationMarker = L.marker(e.latlng).addTo(window.SwiftLogixGlobals.locationMap);
        
        // Store selected coordinates
        window.SwiftLogixGlobals.selectedLat = e.latlng.lat;
        window.SwiftLogixGlobals.selectedLng = e.latlng.lng;
        
        // Display selected location
        document.getElementById('selectedLocation').textContent = 
          `Selected: ${window.SwiftLogixGlobals.selectedLat.toFixed(6)}, ${window.SwiftLogixGlobals.selectedLng.toFixed(6)}`;
        
        // Enable confirm button
        document.getElementById('confirmLocationBtn').disabled = false;
      });
    }
  });

  // Confirm location selection
  document.getElementById('confirmLocationBtn').addEventListener('click', async function() {
    if (window.SwiftLogixGlobals.selectedLat !== null && window.SwiftLogixGlobals.selectedLng !== null) {
      try {
        await updateLocationOnServer(window.SwiftLogixGlobals.selectedLat, window.SwiftLogixGlobals.selectedLng);
        
        // Close modal
        if (typeof bootstrap !== 'undefined') {
          const modal = bootstrap.Modal.getInstance(document.getElementById('locationAccessModal'));
          if (modal) {
            modal.hide();
          }
        }
        
        // Show success message
        showToast('Location updated successfully!', 'success');
      } catch (error) {
        console.error('Failed to update location:', error);
        alert('Failed to update location. Please try again.');
      }
    }
  });

  // Update location on server
  async function updateLocationOnServer(lat, lng) {
    await SwiftLogix.authFetch('/api/driver/location', {
      method: 'POST',
      body: JSON.stringify({
        lat: lat,
        lng: lng
      })
    });
  }

  // Initialize dashboard content
  function initializeDashboardContent() {
    // Load all dashboard data
    refreshDashboard();
    
    // Start periodic refresh every 30 seconds
    setInterval(refreshDashboard, 30000);
  }

  // Refresh dashboard
  async function refreshDashboard() {
    try {
      // Show loading indicator
      const statCards = document.querySelectorAll('.stat-card');
      statCards.forEach(card => {
        const icon = card.querySelector('.stat-icon');
        if (icon) {
          icon.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
        }
      });
      
      // Load all dashboard components in parallel
      await Promise.all([
        loadDashboardStats(),
        loadVehicleInfo()
      ]);
      
      // Restore icons
      const totalOrdersIcon = document.querySelector('#totalOrders').closest('.stat-card').querySelector('.stat-icon');
      if (totalOrdersIcon) totalOrdersIcon.innerHTML = '<i class="fas fa-box"></i>';
      
      const totalEarningsIcon = document.querySelector('#totalEarnings').closest('.stat-card').querySelector('.stat-icon');
      if (totalEarningsIcon) totalEarningsIcon.innerHTML = '<i class="fas fa-rupee-sign"></i>';
      
      const availableOrdersIcon = document.querySelector('#availableOrdersCount').closest('.stat-card').querySelector('.stat-icon');
      if (availableOrdersIcon) availableOrdersIcon.innerHTML = '<i class="fas fa-list"></i>';
      
      const assignedOrdersIcon = document.querySelector('#assignedOrdersCount').closest('.stat-card').querySelector('.stat-icon');
      if (assignedOrdersIcon) assignedOrdersIcon.innerHTML = '<i class="fas fa-tasks"></i>';
      
      showToast('Dashboard updated successfully!', 'success');
    } catch (error) {
      console.error('Error refreshing dashboard:', error);
      showToast('Failed to update dashboard. Please try again.', 'error');
      
      // Restore icons on error
      const totalOrdersIcon = document.querySelector('#totalOrders').closest('.stat-card').querySelector('.stat-icon');
      if (totalOrdersIcon) totalOrdersIcon.innerHTML = '<i class="fas fa-box"></i>';
      
      const totalEarningsIcon = document.querySelector('#totalEarnings').closest('.stat-card').querySelector('.stat-icon');
      if (totalEarningsIcon) totalEarningsIcon.innerHTML = '<i class="fas fa-rupee-sign"></i>';
      
      const availableOrdersIcon = document.querySelector('#availableOrdersCount').closest('.stat-card').querySelector('.stat-icon');
      if (availableOrdersIcon) availableOrdersIcon.innerHTML = '<i class="fas fa-list"></i>';
      
      const assignedOrdersIcon = document.querySelector('#assignedOrdersCount').closest('.stat-card').querySelector('.stat-icon');
      if (assignedOrdersIcon) assignedOrdersIcon.innerHTML = '<i class="fas fa-tasks"></i>';
    }
  }

  // Load dashboard stats
  async function loadDashboardStats() {
    try {
      // Load earnings
      const earningsData = await SwiftLogix.authFetch('/api/driver/earnings');
      
      // Load orders
      const assignedOrders = await SwiftLogix.authFetch('/api/driver/orders');
      const availableOrders = await SwiftLogix.authFetch('/api/driver/orders/available');
      
      // Update UI with smooth transitions
      const totalOrdersEl = document.getElementById('totalOrders');
      const totalEarningsEl = document.getElementById('totalEarnings');
      const availableOrdersCountEl = document.getElementById('availableOrdersCount');
      const assignedOrdersCountEl = document.getElementById('assignedOrdersCount');
      
      // Add fade effect when updating
      const elements = [totalOrdersEl, totalEarningsEl, availableOrdersCountEl, assignedOrdersCountEl];
      elements.forEach(el => {
        if (el) {
          el.style.opacity = '0.5';
          el.style.transition = 'opacity 0.3s ease';
        }
      });
      
      // Small delay for visual effect
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Update values
      if (totalOrdersEl) totalOrdersEl.textContent = earningsData.delivered_count;
      if (totalEarningsEl) totalEarningsEl.textContent = 'â‚¹' + earningsData.total_earnings.toFixed(2);
      if (availableOrdersCountEl) availableOrdersCountEl.textContent = availableOrders.length;
      if (assignedOrdersCountEl) assignedOrdersCountEl.textContent = assignedOrders.length;
      
      // Restore opacity
      elements.forEach(el => {
        if (el) {
          el.style.opacity = '1';
        }
      });
      
    } catch (error) {
      console.error('Failed to load dashboard stats:', error);
      showToast('Failed to load dashboard statistics.', 'error');
    }
  }

  // Load vehicle information
  async function loadVehicleInfo() {
    try {
      const data = await SwiftLogix.authFetch('/api/driver/profile');
      
      document.getElementById('vehicleLoading').style.display = 'none';
      document.getElementById('vehicleData').style.display = 'block';
      
      document.getElementById('vehicleType').textContent = data.vehicle_type || '-';
      document.getElementById('vehicleNumber').textContent = data.vehicle_number || '-';
      document.getElementById('licenseNumber').textContent = data.license_number || '-';
      
      // Update status badge
      const statusBadge = document.getElementById('driverStatus');
      if (data.is_available) {
        statusBadge.className = 'badge bg-success';
        statusBadge.textContent = 'Available';
      } else {
        statusBadge.className = 'badge bg-secondary';
        statusBadge.textContent = 'Not Available';
      }
      
    } catch (error) {
      document.getElementById('vehicleLoading').innerHTML = `
        <div class="alert alert-danger">Failed to load vehicle info: ${error.message}</div>
      `;
    }
  }

  // Load available orders modal with retry mechanism
  async function loadAvailableOrdersModal() {
    // Check if Bootstrap is available with retry mechanism
    if (typeof bootstrap === 'undefined') {
      console.error('Bootstrap is not loaded yet, retrying...');
      setTimeout(loadAvailableOrdersModal, 100);
      return;
    }
    
    try {
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('availableOrdersModal'));
      modal.show();
      
      // Show loading
      document.getElementById('availableOrdersLoading').style.display = 'block';
      document.getElementById('availableOrdersContent').style.display = 'none';
      document.getElementById('noAvailableOrders').style.display = 'none';
      
      // Fetch available orders
      const orders = await SwiftLogix.authFetch('/api/driver/orders/available');
      
      document.getElementById('availableOrdersLoading').style.display = 'none';
      
      if (orders.length === 0) {
        document.getElementById('noAvailableOrders').style.display = 'block';
        return;
      }
      
      document.getElementById('availableOrdersContent').style.display = 'block';
      
      // Populate table
      const tbody = document.getElementById('availableOrdersList');
      tbody.innerHTML = orders.map(order => `
        <tr>
          <td><strong>#${order.id}</strong></td>
          <td>Lat: ${order.pickup[0].toFixed(4)}, Lng: ${order.pickup[1].toFixed(4)}</td>
          <td>Lat: ${order.drop[0].toFixed(4)}, Lng: ${order.drop[1].toFixed(4)}</td>
          <td>â‚¹${order.fare_total}</td>
          <td>
            <button class="btn btn-sm btn-success" onclick="acceptOrder(${order.id})" style="cursor: pointer;">
              <i class="fas fa-check-circle me-1"></i>Accept
            </button>
          </td>
        </tr>
      `).join('');
      
    } catch (error) {
      document.getElementById('availableOrdersLoading').style.display = 'none';
      document.getElementById('availableOrdersContent').innerHTML = `
        <div class="alert alert-danger">Failed to load available orders: ${error.message}</div>
      `;
      document.getElementById('availableOrdersContent').style.display = 'block';
    }
  }

  // Load assigned orders modal with retry mechanism
  async function loadAssignedOrdersModal() {
    // Check if Bootstrap is available with retry mechanism
    if (typeof bootstrap === 'undefined') {
      console.error('Bootstrap is not loaded yet, retrying...');
      setTimeout(loadAssignedOrdersModal, 100);
      return;
    }
    
    try {
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('assignedOrdersModal'));
      modal.show();
      
      // Show loading
      document.getElementById('assignedOrdersLoading').style.display = 'block';
      document.getElementById('assignedOrdersContent').style.display = 'none';
      document.getElementById('noAssignedOrders').style.display = 'none';
      
      // Fetch assigned orders
      const orders = await SwiftLogix.authFetch('/api/driver/orders');
      
      document.getElementById('assignedOrdersLoading').style.display = 'none';
      
      if (orders.length === 0) {
        document.getElementById('noAssignedOrders').style.display = 'block';
        return;
      }
      
      document.getElementById('assignedOrdersContent').style.display = 'block';
      
      // Populate table
      const tbody = document.getElementById('assignedOrdersList');
      tbody.innerHTML = orders.map(order => `
        <tr>
          <td><strong>#${order.id}</strong></td>
          <td>${order.pickup_address || 'N/A'}</td>
          <td>${order.drop_address || 'N/A'}</td>
          <td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td>
          <td>â‚¹${order.driver_share}</td>
          <td>
            ${order.status !== 'delivered' ? 
              `<button class="btn btn-sm btn-success" onclick="markAsDelivered(${order.id})">
                <i class="fas fa-check me-1"></i>Mark as Completed
              </button>` : 
              `<span class="badge bg-success">Delivered</span>`
            }
          </td>
        </tr>
      `).join('');
      
    } catch (error) {
      document.getElementById('assignedOrdersLoading').style.display = 'none';
      document.getElementById('assignedOrdersContent').innerHTML = `
        <div class="alert alert-danger">Failed to load assigned orders: ${error.message}</div>
      `;
      document.getElementById('assignedOrdersContent').style.display = 'block';
    }
  }

  // Accept an order
  async function acceptOrder(orderId) {
    try {
      // Show loading state on the button
      const acceptButton = event.target.closest('button');
      const originalText = acceptButton.innerHTML;
      acceptButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Accepting...';
      acceptButton.disabled = true;
      
      await SwiftLogix.authFetch(`/api/driver/orders/${orderId}/accept`, {
        method: 'POST'
      });
      
      // Restore button state
      acceptButton.innerHTML = originalText;
      acceptButton.disabled = false;
      
      // Show success message
      showToast('Order accepted successfully!', 'success');
      
      // Refresh the available orders list
      loadAvailableOrdersModal();
      
      // Refresh dashboard to update counts
      refreshDashboard();
      
    } catch (error) {
      // Restore button state on error
      const acceptButton = event.target.closest('button');
      if (acceptButton) {
        acceptButton.disabled = false;
        acceptButton.innerHTML = '<i class="fas fa-check-circle me-1"></i>Accept';
      }
      showToast(`Failed to accept order: ${error.message}`, 'error');
    }
  }

  // Mark order as delivered
  async function markAsDelivered(orderId) {
    try {
      await SwiftLogix.authFetch(`/api/driver/orders/${orderId}/status`, {
        method: 'POST',
        body: JSON.stringify({ status: 'delivered' })
      });
      
      // Show success message
      showToast('Order marked as delivered successfully!', 'success');
      
      // Refresh assigned orders
      loadAssignedOrdersModal();
      
      // Refresh dashboard to update counts
      refreshDashboard();
      
    } catch (error) {
      showToast(`Failed to mark order as delivered: ${error.message}`, 'error');
    }
  }

  // Get status color
  function getStatusColor(status) {
    const colors = {
      'pending': 'warning',
      'assigned': 'info',
      'picked': 'primary',
      'delivering': 'primary',
      'delivered': 'success',
      'cancelled': 'danger'
    };
    return colors[status] || 'secondary';
  }

  // Show toast notification with retry mechanism
  function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    // Add to toast container
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toastContainer';
      toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
      document.body.appendChild(toastContainer);
    }
    
    toastContainer.appendChild(toast);
    
    // Initialize and show toast
    if (typeof bootstrap !== 'undefined') {
      const bsToast = new bootstrap.Toast(toast, {
        delay: 3000
      });
      bsToast.show();
      
      // Remove toast after it's hidden
      toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
      });
    } else {
      // If Bootstrap is not available, show a simple alert as fallback
      console.warn('Bootstrap not available, showing alert instead of toast');
      alert(message);
    }
  }

  // Profile functions with retry mechanism
  async function showProfileModal() {
    // Check if Bootstrap is available with retry mechanism
    if (typeof bootstrap === 'undefined') {
      console.error('Bootstrap is not loaded yet, retrying...');
      setTimeout(showProfileModal, 100);
      return;
    }
    
    try {
      const data = await SwiftLogix.authFetch('/api/driver/profile');
      
      // Update profile modal with driver information
      document.getElementById('profileName').textContent = data.name;
      document.getElementById('profileEmail').textContent = data.email;
      document.getElementById('profileDriverId').textContent = 'Registration No: ' + (data.driver_id || 'N/A');
      
      let profileHtml = `
        <div class="row">
          <div class="col-md-6">
            <p><strong>Driver ID:</strong> ${data.driver_id || '-'}</p>
            <p><strong>Phone:</strong> ${data.phone || '-'}</p>
            <p><strong>License Number:</strong> ${data.license_number || '-'}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Vehicle Type:</strong> ${data.vehicle_type || '-'}</p>
            <p><strong>Vehicle Number:</strong> ${data.vehicle_number || '-'}</p>
            <p><strong>Total Deliveries:</strong> ${data.total_deliveries || 0}</p>
          </div>
        </div>
      `;
      
      document.getElementById('profileDetails').innerHTML = profileHtml;
      
      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('profileModal'));
      modal.show();
      
    } catch (error) {
      console.error('Failed to load profile:', error);
      // Silently handle profile loading errors
    }
  }
  
  async function showEditProfileModal() {
    // Check if Bootstrap is available with retry mechanism
    if (typeof bootstrap === 'undefined') {
      console.error('Bootstrap is not loaded yet, retrying...');
      setTimeout(showEditProfileModal, 100);
      return;
    }
    
    try {
      const data = await SwiftLogix.authFetch('/api/driver/profile');
      
      // Populate edit form with current data
      document.getElementById('editName').value = data.name;
      document.getElementById('editEmail').value = data.email;
      document.getElementById('editPhone').value = data.phone || '';
      document.getElementById('editLicenseNumber').value = data.license_number || '';
      document.getElementById('editVehicleType').value = data.vehicle_type || '';
      document.getElementById('editVehicleNumber').value = data.vehicle_number || '';
      
      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
      modal.show();
      
    } catch (error) {
      console.error('Failed to load profile:', error);
      alert('Failed to load profile. Please try again.');
    }
  }
  
  async function updateProfile() {
    try {
      const formData = {
        name: document.getElementById('editName').value,
        phone: document.getElementById('editPhone').value,
        license_number: document.getElementById('editLicenseNumber').value,
        vehicle_type: document.getElementById('editVehicleType').value,
        vehicle_number: document.getElementById('editVehicleNumber').value
      };
      
      await SwiftLogix.authFetch('/api/driver/profile', {
        method: 'PUT',
        body: JSON.stringify(formData)
      });
      
      // Close modal and show success message
      if (typeof bootstrap !== 'undefined') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
        if (modal) {
          modal.hide();
        }
      }
      
      // Show success message
      showToast('Profile updated successfully!', 'success');
      
      // Reload vehicle info
      loadVehicleInfo();
      
    } catch (error) {
      console.error('Failed to update profile:', error);
      alert('Failed to update profile. Please try again.');
    }
  }
</script>

<script>
  // Global variables
  let locationMap = null;
  let locationMarker = null;
  let selectedLat = null;
  let selectedLng = null;

  // Wait for Bootstrap and initialize dashboard
  function waitForBootstrapAndInitialize() {
    if (typeof bootstrap !== 'undefined') {
      // Check authentication
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      
      if (!token || !user || user.role !== 'driver') {
        alert('Please login as a driver to access this page');
        window.location.href = '/login';
        return;
      }

      // Show location access modal
      showLocationAccessModal();
      
      // Initialize dashboard content
      initializeDashboardContent();
    } else {
      // Check again after a short delay
      setTimeout(waitForBootstrapAndInitialize, 100);
    }
  }

  // Initialize dashboard when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    waitForBootstrapAndInitialize();
  });
</script>

<style>
.dashboard-header h2 {
  font-size: 2rem;
  font-weight: 800;
  margin-bottom: 0.5rem;
}

.stat-card {
  border: none;
  border-radius: 15px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  height: 100%;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
}

.stat-icon {
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.stat-card h3 {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.card {
  border: none;
  border-radius: 15px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  margin-bottom: 1.5rem;
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.card-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 15px 15px 0 0 !important;
  padding: 1.25rem;
}

.card-header h5 {
  color: white;
  background: none;
  -webkit-text-fill-color: white;
}

.profile-icon {
  font-size: 2rem;
}

.btn {
  border-radius: 10px;
  padding: 0.75rem 1.5rem;
  font-weight: 600;
  transition: all 0.3s ease;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  cursor: pointer;
}

/* Ensure all interactive buttons have pointer cursor */
button[onclick] {
  cursor: pointer;
}

/* Enhanced responsive behavior */
@media (max-width: 768px) {
  .dashboard-header h2 {
    font-size: 1.75rem;
  }
  
  .stat-card h3 {
    font-size: 1.5rem;
  }
  
  .stat-icon {
    width: 50px;
    height: 50px;
    font-size: 1.25rem;
  }
}

@media (max-width: 576px) {
  .dashboard-header h2 {
    font-size: 1.5rem;
  }
  
  .stat-card h3 {
    font-size: 1.25rem;
  }
  
  .btn {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
  }
}
</style>

<script>
  // Global variables
  let locationMap = null;
  let locationMarker = null;
  let selectedLat = null;
  let selectedLng = null;

  // Wait for Bootstrap and initialize dashboard
  function waitForBootstrapAndInitialize() {
    // Check if Bootstrap and required dependencies are loaded
    if (typeof bootstrap !== 'undefined' && typeof SwiftLogix !== 'undefined') {
      // Check authentication
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      
      if (!token || !user || user.role !== 'driver') {
        alert('Please login as a driver to access this page');
        window.location.href = '/login';
        return;
      }

      // Show location access modal
      showLocationAccessModal();
      
      // Initialize dashboard content
      initializeDashboardContent();
    } else {
      // Check again after a short delay
      setTimeout(waitForBootstrapAndInitialize, 100);
    }
  }

  // Initialize dashboard when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    waitForBootstrapAndInitialize();
  });

  // Show location access modal with retry mechanism
  function showLocationAccessModal() {
    if (typeof bootstrap !== 'undefined') {
      const modal = new bootstrap.Modal(document.getElementById('locationAccessModal'), {
        backdrop: 'static',
        keyboard: false
      });
      modal.show();
    } else {
      // Retry after a short delay
      setTimeout(showLocationAccessModal, 100);
    }
  }

  // Grant location access
  document.getElementById('grantLocationBtn').addEventListener('click', function() {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser');
      return;
    }
    
    navigator.geolocation.getCurrentPosition(
      async (position) => {
        try {
          await updateLocationOnServer(position.coords.latitude, position.coords.longitude);
          
          // Close modal
          if (typeof bootstrap !== 'undefined') {
            const modal = bootstrap.Modal.getInstance(document.getElementById('locationAccessModal'));
            if (modal) {
              modal.hide();
            }
          }
          
          // Show success message
          showToast('Location updated successfully!', 'success');
        } catch (error) {
          console.error('Failed to update location:', error);
          alert('Failed to update location. Please try again.');
        }
      },
      (error) => {
        console.error('Error getting location:', error);
        alert('Unable to retrieve your location. Please try selecting on the map.');
      }
    );
  });

  // Select location on map
  document.getElementById('selectLocationOnMapBtn').addEventListener('click', function() {
    document.getElementById('mapSelector').style.display = 'block';
    
    // Initialize map if not already done
    if (!locationMap) {
      locationMap = SwiftLogix.initMap('locationMap', 28.6139, 77.2090, 12);
      
      // Add click event to map
      locationMap.on('click', function(e) {
        // Remove existing marker if any
        if (locationMarker) {
          locationMap.removeLayer(locationMarker);
        }
        
        // Add new marker
        locationMarker = L.marker(e.latlng).addTo(locationMap);
        
        // Store selected coordinates
        selectedLat = e.latlng.lat;
        selectedLng = e.latlng.lng;
        
        // Display selected location
        document.getElementById('selectedLocation').textContent = 
          `Selected: ${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
        
        // Enable confirm button
        document.getElementById('confirmLocationBtn').disabled = false;
      });
    }
  });

  // Confirm location selection
  document.getElementById('confirmLocationBtn').addEventListener('click', async function() {
    if (window.selectedLat !== null && window.selectedLng !== null) {
      try {
        await updateLocationOnServer(window.selectedLat, window.selectedLng);
        
        // Close modal
        if (typeof bootstrap !== 'undefined') {
          const modal = bootstrap.Modal.getInstance(document.getElementById('locationAccessModal'));
          if (modal) {
            modal.hide();
          }
        }
        
        // Show success message
        showToast('Location updated successfully!', 'success');
      } catch (error) {
        console.error('Failed to update location:', error);
        alert('Failed to update location. Please try again.');
      }
    }
  });

  // Update location on server
  async function updateLocationOnServer(lat, lng) {
    await SwiftLogix.authFetch('/api/driver/location', {
      method: 'POST',
      body: JSON.stringify({
        lat: lat,
        lng: lng
      })
    });
  }

  // Initialize dashboard content
  function initializeDashboardContent() {
    // Load all dashboard data
    refreshDashboard();
    
    // Start periodic refresh every 30 seconds
    setInterval(refreshDashboard, 30000);
  }

  // Refresh dashboard
  async function refreshDashboard() {
    try {
      // Show loading indicator
      const statCards = document.querySelectorAll('.stat-card');
      statCards.forEach(card => {
        const icon = card.querySelector('.stat-icon');
        if (icon) {
          icon.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
        }
      });
      
      // Load all dashboard components in parallel
      await Promise.all([
        loadDashboardStats(),
        loadVehicleInfo()
      ]);
      
      // Restore icons
      const totalOrdersIcon = document.querySelector('#totalOrders').closest('.stat-card').querySelector('.stat-icon');
      if (totalOrdersIcon) totalOrdersIcon.innerHTML = '<i class="fas fa-box"></i>';
      
      const totalEarningsIcon = document.querySelector('#totalEarnings').closest('.stat-card').querySelector('.stat-icon');
      if (totalEarningsIcon) totalEarningsIcon.innerHTML = '<i class="fas fa-rupee-sign"></i>';
      
      const availableOrdersIcon = document.querySelector('#availableOrdersCount').closest('.stat-card').querySelector('.stat-icon');
      if (availableOrdersIcon) availableOrdersIcon.innerHTML = '<i class="fas fa-list"></i>';
      
      const assignedOrdersIcon = document.querySelector('#assignedOrdersCount').closest('.stat-card').querySelector('.stat-icon');
      if (assignedOrdersIcon) assignedOrdersIcon.innerHTML = '<i class="fas fa-tasks"></i>';
      
      showToast('Dashboard updated successfully!', 'success');
    } catch (error) {
      console.error('Error refreshing dashboard:', error);
      showToast('Failed to update dashboard. Please try again.', 'error');
      
      // Restore icons on error
      const totalOrdersIcon = document.querySelector('#totalOrders').closest('.stat-card').querySelector('.stat-icon');
      if (totalOrdersIcon) totalOrdersIcon.innerHTML = '<i class="fas fa-box"></i>';
      
      const totalEarningsIcon = document.querySelector('#totalEarnings').closest('.stat-card').querySelector('.stat-icon');
      if (totalEarningsIcon) totalEarningsIcon.innerHTML = '<i class="fas fa-rupee-sign"></i>';
      
      const availableOrdersIcon = document.querySelector('#availableOrdersCount').closest('.stat-card').querySelector('.stat-icon');
      if (availableOrdersIcon) availableOrdersIcon.innerHTML = '<i class="fas fa-list"></i>';
      
      const assignedOrdersIcon = document.querySelector('#assignedOrdersCount').closest('.stat-card').querySelector('.stat-icon');
      if (assignedOrdersIcon) assignedOrdersIcon.innerHTML = '<i class="fas fa-tasks"></i>';
    }
  }

  // Load dashboard stats
  async function loadDashboardStats() {
    try {
      // Load earnings
      const earningsData = await SwiftLogix.authFetch('/api/driver/earnings');
      
      // Load orders
      const assignedOrders = await SwiftLogix.authFetch('/api/driver/orders');
      const availableOrders = await SwiftLogix.authFetch('/api/driver/orders/available');
      
      // Update UI with smooth transitions
      const totalOrdersEl = document.getElementById('totalOrders');
      const totalEarningsEl = document.getElementById('totalEarnings');
      const availableOrdersCountEl = document.getElementById('availableOrdersCount');
      const assignedOrdersCountEl = document.getElementById('assignedOrdersCount');
      
      // Add fade effect when updating
      const elements = [totalOrdersEl, totalEarningsEl, availableOrdersCountEl, assignedOrdersCountEl];
      elements.forEach(el => {
        if (el) {
          el.style.opacity = '0.5';
        }
      });
      
      // Update values after a short delay for smooth transition
      setTimeout(() => {
        if (totalOrdersEl) totalOrdersEl.textContent = earningsData.total_orders || 0;
        if (totalEarningsEl) totalEarningsEl.textContent = `â‚¹${earningsData.total_earnings || 0}`;
        if (availableOrdersCountEl) availableOrdersCountEl.textContent = availableOrders.length || 0;
        if (assignedOrdersCountEl) assignedOrdersCountEl.textContent = assignedOrders.length || 0;
        
        // Restore opacity
        elements.forEach(el => {
          if (el) {
            el.style.opacity = '1';
          }
        });
      }, 300);
    } catch (error) {
      console.error('Error loading dashboard stats:', error);
      throw error;
    }
  }

  // Load vehicle information
  async function loadVehicleInfo() {
    try {
      const data = await SwiftLogix.authFetch('/api/driver/profile');
      
      document.getElementById('vehicleLoading').style.display = 'none';
      document.getElementById('vehicleData').style.display = 'block';
      
      document.getElementById('vehicleType').textContent = data.vehicle_type || '-';
      document.getElementById('vehicleNumber').textContent = data.vehicle_number || '-';
      document.getElementById('licenseNumber').textContent = data.license_number || '-';
      document.getElementById('driverStatus').textContent = 'Available';
    } catch (error) {
      console.error('Error loading vehicle info:', error);
      document.getElementById('vehicleLoading').style.display = 'none';
      document.getElementById('vehicleData').style.display = 'block';
      
      // Show error state
      document.getElementById('vehicleType').textContent = '-';
      document.getElementById('vehicleNumber').textContent = '-';
      document.getElementById('licenseNumber').textContent = '-';
      document.getElementById('driverStatus').textContent = 'Unknown';
      document.getElementById('driverStatus').className = 'badge bg-secondary';
    }
  }

  // Load available orders modal
  async function loadAvailableOrdersModal() {
    // Check if Bootstrap is available
    if (typeof bootstrap === 'undefined') {
      console.error('Bootstrap is not loaded yet');
      return;
    }
    
    try {
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('availableOrdersModal'));
      modal.show();
      
      // Show loading
      document.getElementById('availableOrdersLoading').style.display = 'block';
      document.getElementById('availableOrdersContent').style.display = 'none';
      document.getElementById('noAvailableOrders').style.display = 'none';
      
      // Fetch available orders
      const orders = await SwiftLogix.authFetch('/api/driver/orders/available');
      
      document.getElementById('availableOrdersLoading').style.display = 'none';
      
      if (orders.length === 0) {
        document.getElementById('noAvailableOrders').style.display = 'block';
        return;
      }
      
      document.getElementById('availableOrdersContent').style.display = 'block';
      
      // Generate order list
      const ordersList = document.getElementById('availableOrdersList');
      ordersList.innerHTML = '';
      
      orders.forEach(order => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${order.id}</td>
          <td>${order.pickup_location}</td>
          <td>${order.delivery_location}</td>
          <td>â‚¹${order.estimated_fare}</td>
          <td>
            <button class="btn btn-sm btn-success" onclick="acceptOrder(${order.id})" style="cursor: pointer;">
              <i class="fas fa-check-circle me-1"></i>Accept
            </button>
          </td>
        `;
        ordersList.appendChild(row);
      });
      
    } catch (error) {
      console.error('Error loading available orders:', error);
      document.getElementById('availableOrdersLoading').style.display = 'none';
      document.getElementById('availableOrdersContent').style.display = 'none';
      document.getElementById('noAvailableOrders').style.display = 'block';
      
      // Show error message
      document.getElementById('noAvailableOrders').innerHTML = '<p class="text-danger">Failed to load orders. Please try again.</p>';
    }
  }

  // Load assigned orders modal
  async function loadAssignedOrdersModal() {
    // Check if Bootstrap is available
    if (typeof bootstrap === 'undefined') {
      console.error('Bootstrap is not loaded yet');
      return;
    }
    
    try {
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('assignedOrdersModal'));
      modal.show();
      
      // Show loading
      document.getElementById('assignedOrdersLoading').style.display = 'block';
      document.getElementById('assignedOrdersContent').style.display = 'none';
      document.getElementById('noAssignedOrders').style.display = 'none';
      
      // Fetch assigned orders
      const orders = await SwiftLogix.authFetch('/api/driver/orders');
      
      document.getElementById('assignedOrdersLoading').style.display = 'none';
      
      if (orders.length === 0) {
        document.getElementById('noAssignedOrders').style.display = 'block';
        return;
      }
      
      document.getElementById('assignedOrdersContent').style.display = 'block';
      
      // Generate order list
      const ordersList = document.getElementById('assignedOrdersList');
      ordersList.innerHTML = '';
      
      orders.forEach(order => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${order.id}</td>
          <td>${order.pickup_location}</td>
          <td>${order.delivery_location}</td>
          <td>
            <span class="badge bg-${order.status === 'assigned' ? 'warning' : order.status === 'in_transit' ? 'primary' : 'success'}">
              ${order.status.replace('_', ' ').toUpperCase()}
            </span>
          </td>
          <td>â‚¹${order.estimated_fare}</td>
          <td>
            ${order.status === 'assigned' || order.status === 'in_transit' ? 
              `<button class="btn btn-sm btn-success" onclick="markAsDelivered(${order.id})" style="cursor: pointer;">
                <i class="fas fa-check me-1"></i>Mark as Delivered
              </button>` : 
              '<span class="text-muted">Completed</span>'
            }
          </td>
        `;
        ordersList.appendChild(row);
      });
      
    } catch (error) {
      console.error('Error loading assigned orders:', error);
      document.getElementById('assignedOrdersLoading').style.display = 'none';
      document.getElementById('assignedOrdersContent').style.display = 'none';
      document.getElementById('noAssignedOrders').style.display = 'block';
      
      // Show error message
      document.getElementById('noAssignedOrders').innerHTML = '<p class="text-danger">Failed to load orders. Please try again.</p>';
    }
  }

  // Accept an order
  async function acceptOrder(orderId) {
    try {
      // Show loading state on the button
      const acceptButton = event.target.closest('button');
      const originalText = acceptButton.innerHTML;
      acceptButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Accepting...';
      acceptButton.disabled = true;
      
      await SwiftLogix.authFetch(`/api/driver/orders/${orderId}/accept`, {
        method: 'POST'
      });
      
      // Restore button state
      acceptButton.innerHTML = originalText;
      acceptButton.disabled = false;
      
      // Show success message
      showToast('Order accepted successfully!', 'success');
      
      // Refresh the available orders list
      loadAvailableOrdersModal();
      
      // Refresh dashboard to update counts
      refreshDashboard();
      
    } catch (error) {
      // Restore button state
      const acceptButton = event.target.closest('button');
      acceptButton.disabled = false;
      acceptButton.innerHTML = '<i class="fas fa-check-circle me-1"></i>Accept';
      
      console.error('Error accepting order:', error);
      alert('Failed to accept order. Please try again.');
    }
  }

  // Mark order as delivered
  async function markAsDelivered(orderId) {
    try {
      // Show loading state on the button
      const deliverButton = event.target.closest('button');
      const originalText = deliverButton.innerHTML;
      deliverButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...';
      deliverButton.disabled = true;
      
      await SwiftLogix.authFetch(`/api/driver/orders/${orderId}/deliver`, {
        method: 'POST'
      });
      
      // Restore button state
      deliverButton.innerHTML = originalText;
      deliverButton.disabled = false;
      
      // Show success message
      showToast('Order marked as delivered!', 'success');
      
      // Refresh the assigned orders list
      loadAssignedOrdersModal();
      
      // Refresh dashboard to update counts
      refreshDashboard();
      
    } catch (error) {
      // Restore button state
      const deliverButton = event.target.closest('button');
      deliverButton.disabled = false;
      deliverButton.innerHTML = '<i class="fas fa-check me-1"></i>Mark as Delivered';
      
      console.error('Error marking order as delivered:', error);
      alert('Failed to mark order as delivered. Please try again.');
    }
  }

  // Show toast notification
  function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toastContainer';
      toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
      document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center border-0 bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} text-white`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Initialize and show toast
    if (typeof bootstrap !== 'undefined') {
      const bsToast = new bootstrap.Toast(toast, {
        delay: 3000
      });
      bsToast.show();
      
      // Remove toast after it's hidden
      toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
      });
    } else {
      // If Bootstrap is not available, show a simple alert as fallback
      console.warn('Bootstrap not available, showing alert instead of toast');
      alert(message);
    }
  }

  // Profile functions with retry mechanism
  async function showProfileModal() {
    // Check if Bootstrap is available with retry mechanism
    if (typeof bootstrap === 'undefined') {
      console.error('Bootstrap is not loaded yet, retrying...');
      setTimeout(showProfileModal, 100);
      return;
    }
    
    try {
      const data = await SwiftLogix.authFetch('/api/driver/profile');
      
      // Update profile modal with driver information
      document.getElementById('profileName').textContent = data.name;
      document.getElementById('profileEmail').textContent = data.email;
      document.getElementById('profileDriverId').textContent = 'Registration No: ' + (data.driver_id || 'N/A');
      
      let profileHtml = `
        <div class="row">
          <div class="col-md-6">
            <p><strong>Driver ID:</strong> ${data.driver_id || '-'}</p>
            <p><strong>Phone:</strong> ${data.phone || '-'}</p>
            <p><strong>License Number:</strong> ${data.license_number || '-'}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Vehicle Type:</strong> ${data.vehicle_type || '-'}</p>
            <p><strong>Vehicle Number:</strong> ${data.vehicle_number || '-'}</p>
            <p><strong>Total Deliveries:</strong> ${data.total_deliveries || 0}</p>
          </div>
        </div>
      `;
      
      document.getElementById('profileDetails').innerHTML = profileHtml;
      
      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('profileModal'));
      modal.show();
      
    } catch (error) {
      console.error('Failed to load profile:', error);
      // Silently handle profile loading errors
    }
  }
  
  async function showEditProfileModal() {
    // Check if Bootstrap is available with retry mechanism
    if (typeof bootstrap === 'undefined') {
      console.error('Bootstrap is not loaded yet, retrying...');
      setTimeout(showEditProfileModal, 100);
      return;
    }
    
    try {
      const data = await SwiftLogix.authFetch('/api/driver/profile');
      
      // Populate edit form with current data
      document.getElementById('editName').value = data.name;
      document.getElementById('editEmail').value = data.email;
      document.getElementById('editPhone').value = data.phone || '';
      document.getElementById('editLicenseNumber').value = data.license_number || '';
      document.getElementById('editVehicleType').value = data.vehicle_type || '';
      document.getElementById('editVehicleNumber').value = data.vehicle_number || '';
      
      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
      modal.show();
      
    } catch (error) {
      console.error('Failed to load profile:', error);
      alert('Failed to load profile. Please try again.');
    }
  }
  
  async function updateProfile() {
    try {
      const formData = {
        name: document.getElementById('editName').value,
        phone: document.getElementById('editPhone').value,
        license_number: document.getElementById('editLicenseNumber').value,
        vehicle_type: document.getElementById('editVehicleType').value,
        vehicle_number: document.getElementById('editVehicleNumber').value
      };
      
      await SwiftLogix.authFetch('/api/driver/profile', {
        method: 'PUT',
        body: JSON.stringify(formData)
      });
      
      // Close modal and show success message
      if (typeof bootstrap !== 'undefined') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
        if (modal) {
          modal.hide();
        }
      }
      
      // Show success message
      showToast('Profile updated successfully!', 'success');
      
      // Reload vehicle info
      loadVehicleInfo();
      
    } catch (error) {
      console.error('Failed to update profile:', error);
      alert('Failed to update profile. Please try again.');
    }
  }
</script>
{% endblock %}