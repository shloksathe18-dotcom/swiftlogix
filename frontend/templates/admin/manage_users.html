{% extends 'base.html' %}
{% block content %}
<div class="dashboard-header mb-4">
  <h2>ðŸ‘¥ User Management</h2>
  <p class="text-muted">View and manage all platform users.</p>
</div>

<div class="row mb-3">
  <div class="col-md-6">
    <a href="/api/admin/orders/export" class="btn btn-success" download>
      <span>ðŸ“¥ Export Orders (CSV)</span>
    </a>
  </div>
  <div class="col-md-6 text-md-end">
    <button class="btn btn-primary" onclick="refreshUsers()">
      <span>ðŸ”„ Refresh Users</span>
    </button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h5 class="mb-0">All Users</h5>
  </div>
  <div class="card-body">
    <div id="loading" class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <div id="usersTable" style="display: none;">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Blocked</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- Users will be populated here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">User Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="userDetailsContent">
        <!-- User details will be populated here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Block User Modal -->
<div class="modal fade" id="blacklistModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Block User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="blacklistUserId">
        <div class="mb-3">
          <label class="form-label">Reason for blocking</label>
          <textarea class="form-control" id="blacklistReason" rows="3" placeholder="Enter reason for blocking this user..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmBlockUser()">Block User</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Check authentication
  const token = localStorage.getItem('token');
  const user = JSON.parse(localStorage.getItem('user') || 'null');
  
  console.log('Token from localStorage:', token);
  console.log('User from localStorage:', user);
  
  if (!token || !user || user.role !== 'admin') {
    console.log('Authentication failed, redirecting to login');
    alert('Please login as an admin to access this page');
    window.location.href = '/login';
  }
  
  // Validate token by making a simple authenticated request
  async function validateToken() {
    try {
      console.log('Validating token:', token);
      if (!token) {
        console.log('No token found, redirecting to login');
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        alert('Session expired. Please login again.');
        window.location.href = '/login';
        return false;
      }
      
      const response = await fetch('/api/admin/dashboard', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      console.log('Token validation response:', response.status, response.statusText);
      
      if (response.ok) {
        console.log('Token is valid');
        return true;
      } else if (response.status === 401) {
        // Token is invalid, clear it and redirect to login
        console.log('Token is invalid, redirecting to login');
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        alert('Session expired. Please login again.');
        window.location.href = '/login';
        return false;
      }
      console.log('Token validation failed with status:', response.status);
      return true;
    } catch (error) {
      // Network error or other issue, but we'll let the user proceed
      console.error('Token validation error:', error);
      return true;
    }
  }

  // New function to handle refresh button click
  async function refreshUsers() {
    console.log('Refresh button clicked');
    // Validate token before refreshing
    if (await validateToken()) {
      loadUsers();
    }
  }
  
  // Load all users with proper null checks
  async function loadUsers() {
    try {
      console.log('Loading users with token:', token);
      if (!token) {
        console.log('No token found, redirecting to login');
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        alert('Session expired. Please login again.');
        window.location.href = '/login';
        return;
      }
      
      // Add null checks for DOM elements
      const loadingEl = document.getElementById('loading');
      const usersTableEl = document.getElementById('usersTable');
      
      if (loadingEl) loadingEl.style.display = 'block';
      if (usersTableEl) usersTableEl.style.display = 'none';
      
      const response = await fetch('/api/admin/users', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      console.log('Users API response:', response.status, response.statusText);
      
      // Handle 401 errors
      if (response.status === 401) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        alert('Session expired. Please login again.');
        window.location.href = '/login';
        return;
      }
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const users = await response.json();
      
      const tbody = document.getElementById('usersTableBody');
      if (tbody) {
        tbody.innerHTML = '';
      }
      
      if (users && Array.isArray(users)) {
        users.forEach(user => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td><span class="badge bg-${getRoleColor(user.role)}">${user.role}</span></td>
            <td><span class="badge bg-${user.is_active ? 'success' : 'danger'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
            <td><span class="badge bg-${user.is_blacklisted ? 'dark' : 'secondary'}">${user.is_blacklisted ? 'Yes' : 'No'}</span></td>
            <td>${formatDate(user.created_at)}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="showUserDetails(${user.id})">
                View
              </button>
              ${!user.is_blacklisted ? 
                `<button class="btn btn-sm btn-outline-danger" onclick="showBlockModal(${user.id})">
                  Block
                </button>` : 
                `<button class="btn btn-sm btn-outline-success" onclick="unblockUser(${user.id})">
                  Unblock
                </button>`
              }
            </td>
          `;
          if (tbody) {
            tbody.appendChild(row);
          }
        });
      }
      
      if (loadingEl) loadingEl.style.display = 'none';
      if (usersTableEl) usersTableEl.style.display = 'block';
      
    } catch (error) {
      console.error('Error loading users:', error);
      // Add null check for loading element
      const loadingEl = document.getElementById('loading');
      if (loadingEl) {
        loadingEl.innerHTML = `
          <div class="alert alert-danger">Failed to load users: ${error.message}</div>
        `;
      }
    }
  }
  
  function getRoleColor(role) {
    switch(role) {
      case 'admin': return 'primary';
      case 'customer': return 'success';
      case 'driver': return 'warning';
      default: return 'secondary';
    }
  }
  
  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString();
  }
  
  async function showUserDetails(userId) {
    try {
      if (!token) {
        console.log('No token found, redirecting to login');
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        alert('Session expired. Please login again.');
        window.location.href = '/login';
        return;
      }
      
      const response = await fetch(`/api/admin/users/${userId}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      // Handle 401 errors
      if (response.status === 401) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        alert('Session expired. Please login again.');
        window.location.href = '/login';
        return;
      }
      
      if (!response.ok) {
        const result = await response.json();
        throw new Error(result.message || `HTTP ${response.status}: ${response.statusText}`);
      }
      
      const user = await response.json();
      
      let detailsHTML = `
        <div class="row">
          <div class="col-md-6">
            <h5>User Information</h5>
            <table class="table table-borderless">
              <tr><td><strong>ID:</strong></td><td>${user.id}</td></tr>
              <tr><td><strong>Name:</strong></td><td>${user.name}</td></tr>
              <tr><td><strong>Email:</strong></td><td>${user.email}</td></tr>
              <tr><td><strong>Role:</strong></td><td><span class="badge bg-${getRoleColor(user.role)}">${user.role}</span></td></tr>
              <tr><td><strong>Status:</strong></td><td><span class="badge bg-${user.is_active ? 'success' : 'danger'}">${user.is_active ? 'Active' : 'Inactive'}</span></td></tr>
              <tr><td><strong>Blocked:</strong></td><td><span class="badge bg-${user.is_blacklisted ? 'dark' : 'secondary'}">${user.is_blacklisted ? 'Yes' : 'No'}</span></td></tr>
              ${user.is_blacklisted ? `<tr><td><strong>Block Reason:</strong></td><td>${user.blacklist_reason || 'No reason provided'}</td></tr>` : ''}
              <tr><td><strong>Created:</strong></td><td>${formatDate(user.created_at)}</td></tr>
            </table>
          </div>
      `;
      
      if (user.role === 'customer' && user.customer_id) {
        detailsHTML += `
          <div class="col-md-6">
            <h5>Customer Details</h5>
            <table class="table table-borderless">
              <tr><td><strong>Customer ID:</strong></td><td>${user.customer_id}</td></tr>
              <tr><td><strong>Total Orders:</strong></td><td>${user.total_orders || 0}</td></tr>
              <tr><td><strong>Completed Orders:</strong></td><td>${user.completed_orders || 0}</td></tr>
              <tr><td><strong>Total Spent:</strong></td><td>â‚¹${(user.total_spent || 0).toFixed(2)}</td></tr>
            </table>
          </div>
        `;
      } else if (user.role === 'driver' && user.driver_id) {
        detailsHTML += `
          <div class="col-md-6">
            <h5>Driver Details</h5>
            <table class="table table-borderless">
              <tr><td><strong>Driver ID:</strong></td><td>${user.driver_id}</td></tr>
              <tr><td><strong>Verified:</strong></td><td><span class="badge bg-${user.is_verified ? 'success' : 'secondary'}">${user.is_verified ? 'Yes' : 'No'}</span></td></tr>
              <tr><td><strong>Available:</strong></td><td><span class="badge bg-${user.is_available ? 'success' : 'secondary'}">${user.is_available ? 'Yes' : 'No'}</span></td></tr>
              <tr><td><strong>Total Deliveries:</strong></td><td>${user.total_deliveries || 0}</td></tr>
              <tr><td><strong>Total Earnings:</strong></td><td>â‚¹${(user.total_earnings || 0).toFixed(2)}</td></tr>
            </table>
          </div>
        `;
      }
      
      detailsHTML += `</div>`;
      
      // Add orders section if available
      if (user.orders && user.orders.length > 0) {
        detailsHTML += `
          <div class="mt-4">
            <h5>Order History</h5>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Status</th>
                    <th>Pickup</th>
                    <th>Drop</th>
                    <th>Distance</th>
                    ${user.role === 'customer' ? '<th>Fare</th>' : '<th>Earnings</th>'}
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
        `;
        
        user.orders.forEach(order => {
          detailsHTML += `
            <tr>
              <td>${order.id}</td>
              <td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td>
              <td>${order.pickup_address ? order.pickup_address.substring(0, 20) + '...' : 'N/A'}</td>
              <td>${order.drop_address ? order.drop_address.substring(0, 20) + '...' : 'N/A'}</td>
              <td>${order.distance_km ? order.distance_km.toFixed(2) + ' km' : 'N/A'}</td>
              <td>â‚¹${user.role === 'customer' ? order.fare_total.toFixed(2) : order.driver_share.toFixed(2)}</td>
              <td>${formatDate(order.created_at)}</td>
            </tr>
          `;
        });
        
        detailsHTML += `
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
      
      const userDetailsContent = document.getElementById('userDetailsContent');
      if (userDetailsContent) {
        userDetailsContent.innerHTML = detailsHTML;
      }
      
      // Show modal using Bootstrap's data-api (no direct bootstrap reference needed)
      const modalElement = document.getElementById('userDetailsModal');
      if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
      
    } catch (error) {
      console.error('Error showing user details:', error);
      alert(`Failed to load user details: ${error.message}`);
    }
  }
  
  function showBlockModal(userId) {
    const blacklistUserId = document.getElementById('blacklistUserId');
    const blacklistReason = document.getElementById('blacklistReason');
    
    if (blacklistUserId) blacklistUserId.value = userId;
    if (blacklistReason) blacklistReason.value = '';
    
    const modalElement = document.getElementById('blacklistModal');
    if (modalElement) {
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    }
  }
  
  async function confirmBlockUser() {
    const blacklistUserId = document.getElementById('blacklistUserId');
    const blacklistReason = document.getElementById('blacklistReason');
    
    const userId = blacklistUserId ? blacklistUserId.value : null;
    const reason = blacklistReason ? blacklistReason.value : '';
    
    if (!userId) {
      console.error('User ID not found');
      return;
    }
    
    try {
      if (!token) {
        console.log('No token found, redirecting to login');
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        alert('Session expired. Please login again.');
        window.location.href = '/login';
        return;
      }
      
      const response = await fetch(`/api/admin/users/${userId}/block`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ reason: reason })
      });
      
      // Handle 401 errors
      if (response.status === 401) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        alert('Session expired. Please login again.');
        window.location.href = '/login';
        return;
      }
      
      if (!response.ok) {
        const result = await response.json();
        throw new Error(result.message || `HTTP ${response.status}: ${response.statusText}`);
      }
      
      // Close modal
      const modalElement = document.getElementById('blacklistModal');
      if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
          modal.hide();
        }
      }
      
      // Show success message
      alert('User has been blocked successfully');
      
      // Refresh user list
      loadUsers();
      
    } catch (error) {
      console.error('Error blocking user:', error);
      alert(`Failed to block user: ${error.message}`);
    }
  }
  
  async function unblockUser(userId) {
    if (!confirm('Are you sure you want to unblock this user?')) {
      return;
    }
    
    try {
      if (!token) {
        console.log('No token found, redirecting to login');
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        alert('Session expired. Please login again.');
        window.location.href = '/login';
        return;
      }
      
      const response = await fetch(`/api/admin/users/${userId}/unblock`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      // Handle 401 errors
      if (response.status === 401) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        alert('Session expired. Please login again.');
        window.location.href = '/login';
        return;
      }
      
      if (!response.ok) {
        const result = await response.json();
        throw new Error(result.message || `HTTP ${response.status}: ${response.statusText}`);
      }
      
      // Show success message
      alert('User has been unblocked successfully');
      
      // Refresh user list
      loadUsers();
      
    } catch (error) {
      console.error('Error unblocking user:', error);
      alert(`Failed to unblock user: ${error.message}`);
    }
  }
  
  function getStatusColor(status) {
    const colors = {
      'pending': 'warning',
      'assigned': 'info',
      'picked': 'primary',
      'delivering': 'primary',
      'delivered': 'success',
      'cancelled': 'danger'
    };
    return colors[status] || 'secondary';
  }

  // Load users when page loads, but first validate the token
  document.addEventListener('DOMContentLoaded', async function() {
    console.log('Page loaded, validating token and loading users');
    // Only proceed if token validation passes
    if (await validateToken()) {
      loadUsers();
    }
  });
</script>

<style>
.dashboard-header h2 {
  font-size: 2rem;
  font-weight: 800;
  margin-bottom: 0.5rem;
}

.card {
  border: none;
  border-radius: 15px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.card-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 15px 15px 0 0 !important;
  padding: 1.25rem;
}

.badge {
  font-weight: 600;
  padding: 0.5em 0.75em;
}

.table-borderless td {
  padding: 0.25rem 0.5rem;
}

.table-striped > tbody > tr:nth-of-type(odd) > * {
  --bs-table-accent-bg: rgba(0, 0, 0, 0.02);
}
</style>
{% endblock %}