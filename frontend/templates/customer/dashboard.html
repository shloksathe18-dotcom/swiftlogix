{% extends 'base.html' %}
{% block content %}
<script>
  // Set dashboard title for customer
  document.addEventListener('DOMContentLoaded', function() {
    const dashboardTitle = document.getElementById('dashboardTitle');
    if (dashboardTitle) {
      dashboardTitle.textContent = ' | Customer Dashboard';
    }
  });
</script>

<div class="dashboard-header mb-4 animate-fadeIn">
  <p class="text-muted">Manage your orders and track deliveries.</p>
</div>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Your Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="profileContent">
        <div class="text-center mb-4">
          <div class="profile-icon bg-primary text-white rounded-circle mx-auto mb-3" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
            üë§
          </div>
          <h5 id="profileName"></h5>
          <p class="text-muted mb-1" id="profileEmail"></p>
          <p class="text-muted small" id="profileCustomerId"></p>
        </div>
        <div id="profileDetails">
          <!-- Profile details will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editProfileForm">
          <div class="mb-3">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-control" id="editName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="editEmail" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Phone Number</label>
            <input type="tel" class="form-control" id="editPhone">
          </div>
          <div class="mb-3">
            <label class="form-label">Address</label>
            <textarea class="form-control" id="editAddress" rows="2"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">City</label>
              <input type="text" class="form-control" id="editCity">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">State</label>
              <input type="text" class="form-control" id="editState">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">ZIP Code</label>
              <input type="text" class="form-control" id="editZipCode">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Country</label>
              <input type="text" class="form-control" id="editCountry" value="India">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="updateProfile()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4 animate-slideInLeft">
  <div class="col-md-4 mb-3">
    <div class="stat-card animate-on-scroll">
      <div class="stat-icon">üì¶</div>
      <h3 id="totalOrders">0</h3>
      <p>Total Orders</p>
    </div>
  </div>
  <div class="col-md-4 mb-3">
    <div class="stat-card animate-on-scroll">
      <div class="stat-icon">üöö</div>
      <h3 id="activeOrders">0</h3>
      <p>Active Orders</p>
    </div>
  </div>
  <div class="col-md-4 mb-3">
    <div class="stat-card animate-on-scroll">
      <div class="stat-icon">‚úÖ</div>
      <h3 id="completedOrders">0</h3>
      <p>Completed</p>
    </div>
  </div>
</div>

<div class="action-buttons mb-4 animate-slideInRight">
  <a href="/customer/create_order" class="btn btn-primary btn-lg animate-on-scroll">
    <span>üì¶ Create New Order</span>
  </a>
  <a href="/customer/track_order" class="btn btn-secondary btn-lg animate-on-scroll">
    <span>üó∫Ô∏è Track Order</span>
  </a>
  <a href="/customer/chat" class="btn btn-info btn-lg animate-on-scroll">
    <span>üí¨ Support Chat</span>
  </a>
</div>

<!-- Recent Orders Section (Kept as requested) -->
<div class="card animate-fadeIn">
  <div class="card-header">
    <h5 class="mb-0">üìã Recent Orders</h5>
  </div>
  <div class="card-body">
    <div id="loading" class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <div id="ordersTable" style="display: none;">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Status</th>
              <th>Distance</th>
              <th>Fare</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="ordersBody"></tbody>
        </table>
      </div>
    </div>
    <div id="noOrders" style="display: none;" class="text-center py-4">
      <p class="text-muted">No orders yet. Create your first order!</p>
    </div>
  </div>
</div>

<script>
  // Check authentication
  const token = localStorage.getItem('token');
  const user = JSON.parse(localStorage.getItem('user') || 'null');
  
  if (!token || !user || user.role !== 'customer') {
    alert('Please login as a customer to access this page');
    window.location.href = '/login';
  }

  // Load orders
  async function loadOrders() {
    try {
      const orders = await SwiftLogix.authFetch('/api/customer/orders');
      
      document.getElementById('loading').style.display = 'none';
      
      if (orders.length === 0) {
        document.getElementById('noOrders').style.display = 'block';
        return;
      }
      
      document.getElementById('ordersTable').style.display = 'block';
      
      // Update stats
      document.getElementById('totalOrders').textContent = orders.length;
      const active = orders.filter(o => ['pending', 'assigned', 'picked', 'delivering'].includes(o.status)).length;
      const completed = orders.filter(o => o.status === 'delivered').length;
      document.getElementById('activeOrders').textContent = active;
      document.getElementById('completedOrders').textContent = completed;
      
      // Populate table
      const tbody = document.getElementById('ordersBody');
      tbody.innerHTML = orders.map(order => `
        <tr class="animate-on-scroll">
          <td><strong>#${order.id}</strong></td>
          <td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td>
          <td>${order.distance_km} km</td>
          <td>‚Çπ${order.fare_total}</td>
          <td>${new Date(order.created_at).toLocaleDateString()}</td>
          <td>
            <a href="/customer/track_order?id=${order.id}" class="btn btn-sm btn-outline-primary">Track</a>
          </td>
        </tr>
      `).join('');
      
      // Trigger animations
      triggerScrollAnimations();
      
    } catch (error) {
      document.getElementById('loading').innerHTML = `
        <div class="alert alert-danger">Failed to load orders. ${error.message}</div>
      `;
    }
  }
  
  // Refresh orders periodically
  function startOrderRefresh() {
    // Refresh orders every 30 seconds
    setInterval(loadOrders, 30000);
  }
  
  function getStatusColor(status) {
    const colors = {
      'pending': 'warning',
      'assigned': 'info',
      'picked': 'primary',
      'delivering': 'primary',
      'delivered': 'success',
      'cancelled': 'danger'
    };
    return colors[status] || 'secondary';
  }
  
  function triggerScrollAnimations() {
    const elements = document.querySelectorAll('.animate-on-scroll');
    elements.forEach((el, index) => {
      // Add delay for staggered effect
      setTimeout(() => {
        el.style.opacity = '1';
        el.style.transform = 'translateY(0)';
      }, index * 100);
    });
  }
  
  // Profile functions
  async function showProfileModal() {
    try {
      const profile = await SwiftLogix.authFetch('/api/customer/profile');
      
      // Update profile header
      document.getElementById('profileName').textContent = profile.name;
      document.getElementById('profileEmail').textContent = profile.email;
      document.getElementById('profileCustomerId').textContent = 'Registration No: ' + (profile.customer_id || 'N/A');
      
      // Update profile details
      let profileDetails = `
        <table class="table table-borderless">
          <tr><td><strong>Customer ID:</strong></td><td>${profile.customer_id || 'N/A'}</td></tr>
          <tr><td><strong>Phone:</strong></td><td>${profile.phone || 'Not provided'}</td></tr>
          <tr><td><strong>Address:</strong></td><td>${profile.address || 'Not provided'}</td></tr>
          <tr><td><strong>City:</strong></td><td>${profile.city || 'Not provided'}</td></tr>
          <tr><td><strong>State:</strong></td><td>${profile.state || 'Not provided'}</td></tr>
          <tr><td><strong>ZIP Code:</strong></td><td>${profile.zip_code || 'Not provided'}</td></tr>
          <tr><td><strong>Country:</strong></td><td>${profile.country || 'Not provided'}</td></tr>
          <tr><td><strong>Total Orders:</strong></td><td>${profile.total_orders || 0}</td></tr>
          <tr><td><strong>Total Spent:</strong></td><td>‚Çπ${(profile.total_spent || 0).toFixed(2)}</td></tr>
          <tr><td><strong>Loyalty Points:</strong></td><td>${profile.loyalty_points || 0}</td></tr>
        </table>
      `;
      
      document.getElementById('profileDetails').innerHTML = profileDetails;
      
      // Show modal
      const modalElement = document.getElementById('profileModal');
      if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
      
    } catch (error) {
      console.error('Failed to load profile:', error);
      // Silently handle profile loading errors
    }
  }
  
  async function showEditProfileModal() {
    try {
      const profile = await SwiftLogix.authFetch('/api/customer/profile');
      
      // Populate form fields
      document.getElementById('editName').value = profile.name;
      document.getElementById('editEmail').value = profile.email;
      document.getElementById('editPhone').value = profile.phone || '';
      document.getElementById('editAddress').value = profile.address || '';
      document.getElementById('editCity').value = profile.city || '';
      document.getElementById('editState').value = profile.state || '';
      document.getElementById('editZipCode').value = profile.zip_code || '';
      document.getElementById('editCountry').value = profile.country || 'India';
      
      // Show modal
      const modalElement = document.getElementById('editProfileModal');
      if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
      
    } catch (error) {
      console.error('Failed to load profile:', error);
      // Silently handle profile loading errors
    }
  }
  
  async function updateProfile() {
    try {
      const profileData = {
        name: document.getElementById('editName').value,
        phone: document.getElementById('editPhone').value,
        address: document.getElementById('editAddress').value,
        city: document.getElementById('editCity').value,
        state: document.getElementById('editState').value,
        zip_code: document.getElementById('editZipCode').value,
        country: document.getElementById('editCountry').value
      };
      
      await SwiftLogix.authFetch('/api/customer/profile', {
        method: 'PUT',
        body: JSON.stringify(profileData)
      });
      
      // Close modal
      const modalElement = document.getElementById('editProfileModal');
      if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
          modal.hide();
        }
      }
      
      // Show success message
      // Profile updated successfully
      
      // Refresh profile if it's open
      const profileModal = document.getElementById('profileModal');
      if (profileModal && profileModal.classList.contains('show')) {
        showProfileModal();
      }
      
    } catch (error) {
      console.error('Failed to update profile:', error);
      alert('Failed to update profile. Please try again.');
    }
  }
  
  // Initialize animations
  document.addEventListener('DOMContentLoaded', function() {
    // Set initial state for animated elements
    const animatedElements = document.querySelectorAll('.animate-on-scroll');
    animatedElements.forEach(el => {
      el.style.opacity = '0';
      el.style.transform = 'translateY(20px)';
      el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
    });
    
    // Trigger animations after a short delay
    setTimeout(triggerScrollAnimations, 300);
  });
  
  // Load orders when page loads
  document.addEventListener('DOMContentLoaded', function() {
    loadOrders();
    startOrderRefresh(); // Start periodic refresh
  });
</script>

<style>
.dashboard-header h2 {
  font-size: 2rem;
  font-weight: 800;
  margin-bottom: 0.5rem;
}

.stat-card {
  background: white;
  padding: 2rem;
  border-radius: 15px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  text-align: center;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s ease;
}

.stat-card:hover::before {
  left: 100%;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
  border-color: #667eea;
}

.stat-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  transition: transform 0.3s ease;
}

.stat-card:hover .stat-icon {
  transform: scale(1.1);
}

.stat-card h3 {
  font-size: 2.5rem;
  font-weight: 800;
  margin-bottom: 0.5rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.stat-card p {
  color: #6b7280;
  margin: 0;
  font-weight: 600;
}

.action-buttons {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.action-buttons .btn {
  flex: 1;
  min-width: 200px;
  position: relative;
  overflow: hidden;
  z-index: 1;
}

.action-buttons .btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s ease;
  z-index: -1;
}

.action-buttons .btn:hover::before {
  left: 100%;
}

.card {
  border: none;
  border-radius: 15px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  margin-bottom: 2rem;
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.card-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 15px 15px 0 0 !important;
  padding: 1.25rem;
}

.card-header h5 {
  color: white;
  background: none;
  -webkit-text-fill-color: white;
}

.profile-icon {
  font-size: 2rem;
}

/* Enhanced responsive behavior */
@media (max-width: 768px) {
  .action-buttons {
    flex-direction: column;
  }
  
  .action-buttons .btn {
    min-width: 100%;
  }
  
  .stat-card {
    padding: 1.5rem;
  }
  
  .stat-card h3 {
    font-size: 2rem;
  }
  
  .stat-icon {
    font-size: 2.5rem;
  }
  
  .table-responsive {
    font-size: 0.85rem;
  }
  
  .table thead th,
  .table tbody td {
    padding: 0.5rem;
  }
}
</style>
{% endblock %}